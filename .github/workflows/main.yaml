name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Run Tests
        run: zig build test

      - name: Cross-Platform Build (Releases Only)
        if: github.event_name == 'release'
        run: |
          # Target List: Arch-OS-ABI
          # gnu: standard Linux, windows, macos
          # musl: static Linux (portable)
          # wasi: WebAssembly
          TARGETS=(
            "x86_64-linux"
            "aarch64-linux"
            "riscv64-linux"
            "x86_64-windows"
            "aarch64-windows"
            "x86_64-macos"
            "aarch64-macos"
            "x86_64-freebsd"
            "aarch64-linux-android"
            "wasm32-freestanding"
            "wasm64-freestanding"
          )

          for target in "${TARGETS[@]}"; do
            echo "Building for $target..."
            
            zig build -Doptimize=ReleaseSafe -Dtarget=$target --prefix "dist/$target"
           
            tar -czf "$target-build.tar.gz" -C "dist" "$target"
          done

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: "*-build.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
